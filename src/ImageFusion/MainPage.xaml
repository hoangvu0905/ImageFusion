<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:ImageFusion.ViewModels"
             xmlns:models="clr-namespace:ImageFusion.Models"
             xmlns:converters="clr-namespace:ImageFusion.Converters"
             x:Class="ImageFusion.MainPage"
             x:DataType="viewmodels:MainViewModel"
             Title="ImageFusion">

    <ContentPage.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <converters:CountToBoolConverter x:Key="CountToBoolConverter" />
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*">
        <!-- Header -->
        <Grid Grid.Row="0" 
              Padding="16,8" 
              BackgroundColor="{StaticResource Primary}"
              ColumnDefinitions="*,Auto,Auto">
            
            <Label Text="ImageFusion" 
                   FontSize="20" 
                   FontAttributes="Bold"
                   TextColor="White"
                   VerticalOptions="Center" />
            
            <Button Grid.Column="1"
                    Text="Add"
                    Margin="8,0"
                    Command="{Binding AddImagesCommand}"
                    BackgroundColor="White"
                    TextColor="{StaticResource Primary}" />
            
            <Button Grid.Column="2"
                    Text="Export"
                    Command="{Binding ExportCommand}"
                    BackgroundColor="White"
                    TextColor="{StaticResource Primary}" />
        </Grid>

        <!-- Tab Content -->
        <Grid Grid.Row="1" RowDefinitions="*,Auto">
            <!-- Tab Pages -->
            <Grid Grid.Row="0">
                <!-- Original Tab -->
                <Grid IsVisible="{Binding SelectedTabIndex, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=1}">
                    <Grid x:Name="OriginalTab">
                        <!-- No Images State -->
                        <VerticalStackLayout IsVisible="{Binding HasImages, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=invert}"
                                           VerticalOptions="Center"
                                           HorizontalOptions="Center"
                                           Spacing="20">
                            <Label Text="No images added yet"
                                   FontSize="18"
                                   HorizontalOptions="Center" />
                            <Button Text="Add Images"
                                    Command="{Binding AddImagesCommand}"
                                    HorizontalOptions="Center" />
                        </VerticalStackLayout>

                        <!-- Images List -->
                        <CollectionView IsVisible="{Binding HasImages}"
                                       ItemsSource="{Binding Images}"
                                       ItemsLayout="HorizontalList"
                                       HeightRequest="250"
                                       VerticalOptions="Center">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:ImageItem">
                                    <Grid Margin="8" WidthRequest="200" HeightRequest="200">
                                        <Border StrokeShape="RoundRectangle 8"
                                               Stroke="{StaticResource Gray200}"
                                               StrokeThickness="1">
                                            <Image Source="{Binding ThumbnailSource}"
                                                   Aspect="AspectFit" />
                                        </Border>
                                        <Button Text="âœ•"
                                               WidthRequest="32"
                                               HeightRequest="32"
                                               Padding="0"
                                               CornerRadius="16"
                                               BackgroundColor="#FF4444"
                                               TextColor="White"
                                               HorizontalOptions="Start"
                                               VerticalOptions="Start"
                                               Margin="4"
                                               Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=RemoveImageCommand}"
                                               CommandParameter="{Binding .}" />
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </Grid>
                </Grid>

                <!-- Preview Tab -->
                <Grid IsVisible="{Binding SelectedTabIndex, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=0}">
                    <Grid x:Name="PreviewTab">
                        <ActivityIndicator IsRunning="{Binding IsProcessing}"
                                          IsVisible="{Binding IsProcessing}"
                                          VerticalOptions="Center"
                                          HorizontalOptions="Center" />
                        
                        <ScrollView Orientation="Both" IsVisible="{Binding IsProcessing, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=invert}">
                            <Image Source="{Binding PreviewImageSource}"
                                   Aspect="AspectFit"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center">
                                <Image.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnPreviewImageTapped" />
                                </Image.GestureRecognizers>
                            </Image>
                        </ScrollView>
                        
                        <Label Text="Add images to see preview"
                               IsVisible="{Binding HasImages, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=invert}"
                               HorizontalOptions="Center"
                               VerticalOptions="Center"
                               FontSize="16" />
                    </Grid>
                </Grid>

                <!-- Settings Tab -->
                <ScrollView IsVisible="{Binding SelectedTabIndex, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=2}">
                    <VerticalStackLayout Padding="16" Spacing="16">
                        <Label Text="Output Settings" FontSize="18" FontAttributes="Bold" />
                        
                        <!-- Output Dimensions -->
                        <Grid ColumnDefinitions="*,*" ColumnSpacing="16">
                            <VerticalStackLayout Grid.Column="0">
                                <Label Text="Width" />
                                <Entry Text="{Binding OutputWidth}" Keyboard="Numeric" />
                            </VerticalStackLayout>
                            <VerticalStackLayout Grid.Column="1">
                                <Label Text="Height" />
                                <Entry Text="{Binding OutputHeight}" Keyboard="Numeric" />
                            </VerticalStackLayout>
                        </Grid>
                        
                        <BoxView HeightRequest="1" Color="{StaticResource Gray200}" />
                        <Label Text="Border Settings" FontSize="18" FontAttributes="Bold" />
                        
                        <!-- Border Settings -->
                        <Grid ColumnDefinitions="*,*" ColumnSpacing="16">
                            <VerticalStackLayout Grid.Column="0">
                                <Label Text="Border Pixel" />
                                <Entry Text="{Binding BorderPixel}" Keyboard="Numeric" />
                            </VerticalStackLayout>
                            <VerticalStackLayout Grid.Column="1">
                                <Label Text="Border Color (Hex)" />
                                <Entry Text="{Binding BorderColorHex}" Placeholder="#FFFFFF" />
                            </VerticalStackLayout>
                        </Grid>
                        
                        <BoxView HeightRequest="1" Color="{StaticResource Gray200}" />
                        <Label Text="Split Settings" FontSize="18" FontAttributes="Bold" />
                        
                        <!-- Split Settings -->
                        <Grid ColumnDefinitions="*,*" ColumnSpacing="16">
                            <VerticalStackLayout Grid.Column="0">
                                <Label Text="Split Pixel" />
                                <Entry Text="{Binding SplitPixel}" Keyboard="Numeric" />
                            </VerticalStackLayout>
                            <VerticalStackLayout Grid.Column="1">
                                <Label Text="Split Color (Hex)" />
                                <Entry Text="{Binding SplitColorHex}" Placeholder="#FFFFFF" />
                            </VerticalStackLayout>
                        </Grid>
                        
                        <BoxView HeightRequest="1" Color="{StaticResource Gray200}" />
                        <Label Text="Merge Layout" FontSize="18" FontAttributes="Bold" />
                        
                        <!-- Layout Options -->
                        <Label Text="(Available when 3+ images)" 
                               FontSize="12" 
                               TextColor="{StaticResource Gray400}"
                               IsVisible="{Binding ShowLayoutOptions, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=invert}" />
                        
                        <Picker Title="Select Layout"
                               ItemsSource="{Binding AvailableLayouts}"
                               SelectedItem="{Binding MergeLayout}"
                               IsEnabled="{Binding ShowLayoutOptions}" />
                        
                        <BoxView HeightRequest="1" Color="{StaticResource Gray200}" />
                        <Label Text="Image Format" FontSize="18" FontAttributes="Bold" />
                        
                        <!-- Format Options -->
                        <Picker Title="Select Format"
                               ItemsSource="{Binding AvailableFormats}"
                               SelectedItem="{Binding ImageFormat}" />
                    </VerticalStackLayout>
                </ScrollView>
            </Grid>

            <!-- Tab Bar -->
            <Grid Grid.Row="1" 
                  ColumnDefinitions="*,*,*"
                  BackgroundColor="{StaticResource White}"
                  Padding="0,8">
                
                <Button Grid.Column="0"
                       Text="Preview"
                       BackgroundColor="{Binding SelectedTabIndex, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=0}"
                       Clicked="OnPreviewTabClicked"
                       IsEnabled="{Binding HasImages}" />
                
                <Button Grid.Column="1"
                       Text="Original"
                       Clicked="OnOriginalTabClicked" />
                
                <Button Grid.Column="2"
                       Text="Settings"
                       Clicked="OnSettingsTabClicked" />
            </Grid>
        </Grid>
    </Grid>
</ContentPage>
